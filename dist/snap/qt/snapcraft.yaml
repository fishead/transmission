name: transmission-qt
adopt-info: transmission-qt
summary: Fast, easy, and free BitTorrent client
description: |
  Transmission is a cross-platform BitTorrent client which features a variety
  of user interfaces on top of a cross-platform back-end.

  Feature Spotlight:
    * Uses fewer resources than other clients
    * Native Mac, GTK and Qt GUI clients
    * Daemon ideal for servers, embedded systems, and headless use
    * All these can be remote controlled by Web and Terminal clients
    * Local Peer Discovery
    * Full encryption, DHT, uTP, PEX and Magnet Link support

   This package contains the Qt client which, along with all the above
   features, allows you to connect to remote Transmission instances like e.g.
   the Daemon running on a headless server. It integrates best with Qt-based
   systems like KDE, Lumina, LXQt, and Trinity.

  Transmission is free software licensed under the terms of the GNU General
  Public License (GNU GPL), with parts under the MIT License.

grade: devel
confinement: strict

plugs:
  icon-themes:
    interface: content
    target: $SNAP/usr/share/icons
    default-provider: gtk-common-themes

slots:
  dbus-daemon:
    interface: dbus
    bus: session
    name: com.transmissionbt.Transmission

parts:
  transmission-qt:
    source: ../../..
    plugin: cmake
    override-pull: |
      snapcraftctl pull
      snapcraftctl set-version $(test -n "${TR_VERSION}" && echo "${TR_VERSION}" || git describe --tags --abbrev=10)
    override-build: |
      sed -i.bak -e 's|^Icon=.*$|Icon=${SNAP}/meta/gui/transmission.png|g' ../src/qt/transmission-qt.desktop
      snapcraftctl build
      strip $SNAPCRAFT_PART_INSTALL/bin/transmission-qt
      mkdir -p $SNAPCRAFT_PART_INSTALL/meta/gui/
      cp ../src/qt/icons/transmission.png $SNAPCRAFT_PART_INSTALL/meta/gui/
    configflags:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DENABLE_DAEMON=OFF
      - -DENABLE_GTK=OFF
      - -DENABLE_QT=ON
      - -DENABLE_TESTS=OFF
      - -DENABLE_UTILS=OFF
      - -DUSE_SYSTEM_B64=OFF
      - -DUSE_SYSTEM_DHT=OFF
      - -DUSE_SYSTEM_EVENT2=ON
      - -DUSE_SYSTEM_MINIUPNPC=OFF
      - -DUSE_SYSTEM_NATPMP=OFF
      - -DUSE_SYSTEM_UTP=OFF
      - -DWITH_CRYPTO=openssl
      - -DWITH_INOTIFY=ON
      - -DWITH_SYSTEMD=OFF
    build-packages:
      - git
      - libcurl4-openssl-dev
      - libevent-dev
      - libssl-dev
      - pkg-config
      - qtbase5-dev
      - qttools5-dev
      - qttools5-dev-tools
      - zlib1g-dev
    stage-packages:
      - libcurl3
      - libevent-2.0-5
      - libqt5core5a
      - libqt5dbus5
      - libqt5gui5
      - libqt5network5
      - libqt5widgets5
      - libssl1.0.0
      - zlib1g
    stage:
      - -usr/lib/x86_64-linux-gnu/dri
      - -usr/lib/x86_64-linux-gnu/libLLVM-6.0.so
      - -usr/lib/x86_64-linux-gnu/libLLVM-6.0.so.1
      - -usr/share/doc
      - -usr/share/icons/*
  desktop-qt:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: qt
    plugin: make
    make-parameters:
      - FLAVOR=qt5
    build-packages:
      - qtbase5-dev
      - dpkg-dev
    override-build: |
      snapcraftctl build
      install -m755 -d $SNAPCRAFT_PART_INSTALL/usr/share/icons
      install -m755 -d $SNAPCRAFT_PART_INSTALL/usr/share/themes
    stage-packages:
      - appmenu-qt5
      - libxkbcommon0
      - light-themes
      - shared-mime-info
      - libgdk-pixbuf2.0-0
      - libqt5gui5
      - libqt5svg5
      - xdg-user-dirs
    stage:
      - -usr/lib/x86_64-linux-gnu/dri
      - -usr/lib/x86_64-linux-gnu/libLLVM-6.0.so
      - -usr/lib/x86_64-linux-gnu/libLLVM-6.0.so.1
      - -usr/share/doc
      - -usr/share/icons/*

apps:
  transmission-qt:
    command: desktop-launch transmission-qt
    plugs:
      - desktop
      - home
      - network
      - network-bind
      - removable-media
      - wayland
      - x11
    desktop: share/applications/transmission-qt.desktop
